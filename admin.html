<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoanJane Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #2c2c2c; font-family: 'Noto Sans TC'; color: #fff; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        h2 { color: #E2C8BA; text-align: center; border-bottom: 1px solid #555; padding-bottom: 15px; }
        
        #loadingOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #E2C8BA; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .card { background: #333; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: none; }
        .card.active { display: block; }
        
        /* å¿«é€Ÿç™¼é€å°ˆç”¨æ¨£å¼ */
        .quick-box { background: #fff5f5; border: 2px solid #ff7675; padding: 20px; border-radius: 15px; margin-bottom: 20px; color: #333; }
        
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;}
        .nav-btn { flex: 1; padding: 12px; background: #444; color: #aaa; border: none; border-radius: 5px; cursor: pointer; font-weight: 700; transition: 0.3s; }
        .nav-btn.active { background: #E2C8BA; color: #000; }
        
        .label { font-size: 13px; color: #bbb; margin-bottom: 6px; display: block; }
        .input, .select { width: 100%; padding: 12px; background: #444; border: 1px solid #555; color: white; border-radius: 6px; box-sizing: border-box; margin-bottom: 15px; font-size: 16px;}
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: #E2C8BA; color: #000; }
        .btn-danger { background: #e74c3c; color: #fff; padding: 6px 12px; width: auto; font-size: 13px;}
        .btn-quick { background: #d63031; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; z-index: 999; display: flex; align-items: center; justify-content: center; }
        
        .member-info { background: #222; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #555; }
        .coupon-item { background: #fff; color: #000; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div style="color:white; margin-top:15px;">è™•ç†ä¸­...</div>
    </div>

    <div id="loginOverlay">
        <div style="text-align: center; width: 80%; max-width: 300px;">
            <h3 style="color: #E2C8BA;">RoanJane å¾Œå°</h3>
            <input type="password" id="adminPwd" class="input" placeholder="å¯†ç¢¼">
            <button class="btn btn-primary" onclick="login()">ç™» å…¥</button>
        </div>
    </div>

    <div class="container" id="mainContent" style="display:none;">
        <h2>å¾Œå°ç®¡ç†ç³»çµ±</h2>
        
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchTab('marketing', this)">ç™¼é€å„ªæƒ åˆ¸</button>
            <button class="nav-btn" onclick="switchTab('pos', this)">æŸ¥è©¢ / æ ¸éŠ·</button>
            <button class="nav-btn" onclick="switchTab('stats', this); loadStats()">æ•¸æ“šå ±è¡¨</button>
        </div>

        <!-- å„ªæƒ åˆ¸ç™¼é€é é¢ -->
        <div id="marketingSection" class="card active">
            <!-- å¿«é€Ÿç™¼é€å€ (å·²ä¿®æ­£éš±è—å•é¡Œ) -->
            <div class="quick-box">
                <h3 style="color: #d63031; margin-top: 0;">ğŸ§§ å¿«é€Ÿç™¼é€ï¼šæ»¿è¬é€åƒè³€ç¦®</h3>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="tel" id="quick-phone" placeholder="è¼¸å…¥é›»è©± (å¦‚: 0912345678)" 
                           style="flex: 1; padding: 12px; border: 1px solid #ff7675; border-radius: 8px; font-size: 16px;">
                    <button onclick="quickSendCoupon()" id="quick-send-btn" class="btn-quick">ç«‹å³ç™¼é€</button>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    â€» é è¨­ï¼šä½¿ç”¨æœŸé™è‡³ 2026/03/31ï¼Œä½æ¶ˆ3000å…ƒï¼Œåœ–ç‰‡å·²é–å®šã€‚
                </p>
            </div>

            <h3 style="margin-top:20px; border-top: 1px solid #555; padding-top: 20px;">ğŸ¯ å…¶ä»–å„ªæƒ åˆ¸æ´¾ç™¼</h3>
            <label class="label">ç™¼é€å°è±¡</label>
            <select id="targetType" class="select" onchange="toggleTarget()">
                <option value="single">å–®ä¸€æœƒå“¡ (è¼¸å…¥é›»è©±)</option>
                <option value="birthday">æœ¬æœˆå£½æ˜Ÿ (å…¨é«”)</option>
                <option value="vip">VIP æœƒå“¡ (å…¨é«”)</option>
                <option value="all">æ‰€æœ‰æœƒå“¡ (å…¨é«”)</option>
            </select>

            <div id="targetValueRow">
                <label class="label" id="targetLabel">æœƒå“¡é›»è©±</label>
                <input type="text" id="targetValue" class="input" placeholder="ä¾‹å¦‚: 0912345678">
            </div>

            <label class="label">å„ªæƒ åˆ¸åç¨±</label>
            <input type="text" id="couponName" class="input" placeholder="ä¾‹å¦‚: ç”Ÿæ—¥ç¦®é‡‘$500">
            <label class="label">åˆ°æœŸæ—¥ (å¿…å¡«)</label>
            <input type="date" id="expiryDate" class="input">
            <label class="label">ä½¿ç”¨æ¢ä»¶ (èªªæ˜æ–‡å­—)</label>
            <input type="text" id="couponTerms" class="input" placeholder="ä¾‹å¦‚: é™è³¼æ–°å“ä½¿ç”¨">
            <label class="label">å„ªæƒ åˆ¸åœ–ç‰‡ (ä¸Šå‚³)</label>
            <input type="file" id="couponFile" accept="image/*">

            <button class="btn btn-primary" onclick="sendCoupon()">ç¢ºèªç™¼é€</button>
        </div>

        <!-- æŸ¥è©¢æ ¸éŠ·é é¢ -->
        <div id="posSection" class="card">
            <h3 style="margin-top:0;">ğŸ›ï¸ æŸ¥è©¢èˆ‡æ ¸éŠ·</h3>
            <input type="tel" id="searchPhone" class="input" placeholder="è¼¸å…¥æœƒå“¡é›»è©±">
            <button class="btn btn-primary" onclick="searchMember()">æŸ¥ è©¢</button>
            
            <div id="memberResult" style="margin-top: 20px; display: none;">
                <div class="member-info">
                    <strong id="memName" style="color:#E2C8BA; font-size: 20px;"></strong><br>
                    é›»è©±: <span id="memPhone"></span>
                </div>
                <h4 style="margin: 10px 0; border-bottom:1px solid #555; padding-bottom:5px;">æŒæœ‰å„ªæƒ åˆ¸</h4>
                <div id="couponList"></div>
            </div>
        </div>

        <!-- å ±è¡¨é é¢ -->
        <div id="statsSection" class="card">
            <h3 style="margin-top:0; display:flex; justify-content:space-between;">
                ğŸ“Š ä½¿ç”¨ç‡åˆ†æ
                <button onclick="loadStats()" style="background:none; border:none; color:#E2C8BA; font-size:14px; cursor:pointer;">â†» æ›´æ–°</button>
            </h3>
            <div id="statsList"></div>
        </div>
    </div>

    <script>
        // è¨­å®š API ç¶²å€
        const API_URL = "https://script.google.com/macros/s/AKfycbzyty-mdu2mU-AD-KKwoQf-sD2soyjxbcoOW25ViFu38vlTwDY-p0NTomic5RRcqkqT/exec";
        let PASSWORD = "";

        function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

        // ç™»å…¥åŠŸèƒ½
        function login() {
            var pwd = document.getElementById('adminPwd').value;
            if(!pwd) return Swal.fire('éŒ¯èª¤', 'è«‹è¼¸å…¥å¯†ç¢¼', 'error');
            
            showLoading();
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'verify_admin', password: pwd })
            })
            .then(r => r.json())
            .then(res => {
                hideLoading();
                if(res.status === 'success') {
                    PASSWORD = pwd;
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    let d = new Date(); d.setMonth(d.getMonth() + 1);
                    document.getElementById('expiryDate').valueAsDate = d;
                    toggleTarget();
                } else {
                    Swal.fire('éŒ¯èª¤', 'å¯†ç¢¼éŒ¯èª¤', 'error');
                }
            });
        }

        // å¿«é€Ÿç™¼é€åŠŸèƒ½ (ä¿®æ­£è®Šæ•¸åèˆ‡æµç¨‹)
        async function quickSendCoupon() {
            const phone = document.getElementById('quick-phone').value.trim();
            if (!phone) return Swal.fire('æé†’', 'è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼', 'info');

            const btn = document.getElementById('quick-send-btn');
            btn.disabled = true;
            btn.innerText = "ç™¼é€ä¸­...";

            const payload = {
                action: 'give_coupon',
                password: PASSWORD,
                targetType: 'single',
                targetValue: phone,
                couponName: "æ»¿è¬é€åƒè³€ç¦®",
                couponImg: "https://i.postimg.cc/1tFJGj18/Snipaste-2026-01-28-10-05-04.png",
                expiryDate: "2026/03/31",
                couponTerms: "ä½æ¶ˆ3000å¯ä½¿ç”¨ä¸€å¼µ"
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    Swal.fire('å®Œæˆ', 'âœ… ç™¼é€æˆåŠŸï¼é¡§å®¢å·²æ”¶åˆ°å„ªæƒ åˆ¸', 'success');
                    document.getElementById('quick-phone').value = "";
                } else {
                    Swal.fire('å¤±æ•—', result.message, 'error');
                }
            } catch (e) {
                Swal.fire('éŒ¯èª¤', 'ç³»çµ±é€£ç·šå¤±æ•—', 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = "ç«‹å³ç™¼é€";
            }
        }

        // æŸ¥è©¢æœƒå“¡ (ä¿®æ­£ undefined å•é¡Œ)
        function searchMember() {
            var phone = document.getElementById('searchPhone').value;
            if(!phone) return;
            showLoading();
            
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_search', password: PASSWORD, phone: phone }) })
            .then(r => r.json()).then(res => {
                hideLoading();
                if(res.status !== 'success') return Swal.fire('éŒ¯èª¤', res.message, 'error');
                
                var d = res.data;
                // ä¿®æ­£å°æ‡‰å¾Œç«¯å‚³å›çš„æ¬„ä½
                document.getElementById('memName').innerText = d.name || "æœªçŸ¥åç¨±";
                document.getElementById('memPhone').innerText = d.phone || "ç„¡é›»è©±è³‡æ–™";
                
                var list = document.getElementById('couponList');
                list.innerHTML = "";
                
                if(d.coupons && d.coupons.trim() !== "") {
                    d.coupons.split(',').forEach(c => {
                        if(c.trim()) {
                            let parts = c.split('|');
                            let name = parts[0];
                            let date = parts[2] ? `(${parts[2]}åˆ°æœŸ)` : '';
                            list.innerHTML += `
                                <div class="coupon-item">
                                    <span>${name} <small style="color:red">${date}</small></span>
                                    <button class="btn-danger" onclick="redeem('${phone}', '${c}')">æ ¸éŠ·</button>
                                </div>`;
                        }
                    });
                } else {
                    list.innerHTML = "<div style='color:#777; text-align:center; padding:10px;'>ç„¡å¯ç”¨å„ªæƒ åˆ¸</div>";
                }
                document.getElementById('memberResult').style.display = 'block';
            });
        }

        // åˆ‡æ›åˆ†é 
        function switchTab(id, btn) {
            document.querySelectorAll('.card').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id + 'Section').classList.add('active');
            btn.classList.add('active');
        }

        // ç™¼é€å°è±¡åˆ‡æ›
        function toggleTarget() {
            var type = document.getElementById('targetType').value;
            var row = document.getElementById('targetValueRow');
            var label = document.getElementById('targetLabel');
            var input = document.getElementById('targetValue');

            if (type === 'single') {
                row.style.display = 'block';
                label.innerText = 'æœƒå“¡é›»è©±';
                input.placeholder = 'ä¾‹å¦‚: 0912345678';
                input.type = 'tel';
            } else if (type === 'birthday') {
                row.style.display = 'block';
                label.innerText = 'å£½æ˜Ÿæœˆä»½ (1-12)';
                input.placeholder = 'ä¾‹å¦‚: 12';
                input.type = 'number';
            } else {
                row.style.display = 'none';
            }
        }

        // ä¸€èˆ¬å„ªæƒ åˆ¸ç™¼é€
        function sendCoupon() {
            var name = document.getElementById('couponName').value;
            var date = document.getElementById('expiryDate').value;
            var fileInput = document.getElementById('couponFile');
            
            if(!name || !date) return Swal.fire('éŒ¯èª¤', 'è«‹å¡«å¯«åç¨±èˆ‡åˆ°æœŸæ—¥', 'error');
            
            var sendData = {
                action: 'give_coupon', password: PASSWORD,
                targetType: document.getElementById('targetType').value,
                targetValue: document.getElementById('targetValue').value,
                couponName: name,
                expiryDate: date,
                couponTerms: document.getElementById('couponTerms').value
            };

            var processSend = function(payload) {
                showLoading();
                fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(r => r.json()).then(res => {
                    hideLoading();
                    Swal.fire(res.status==='success'?'æˆåŠŸ':'å¤±æ•—', res.message, res.status);
                });
            };

            Swal.fire({
                title: 'ç¢ºèªç™¼é€?', icon: 'warning',
                showCancelButton: true, confirmButtonText: 'ç™¼é€'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (fileInput.files.length > 0) {
                        var reader = new FileReader();
                        reader.readAsDataURL(fileInput.files[0]);
                        reader.onload = function () {
                            sendData.imageBase64 = reader.result; 
                            processSend(sendData);
                        };
                    } else {
                        processSend(sendData);
                    }
                }
            });
        }

        // æ ¸éŠ·
        function redeem(phone, couponData) {
            Swal.fire({
                title: 'ç¢ºå®šæ ¸éŠ·?', icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#e74c3c', confirmButtonText: 'æ ¸éŠ·'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    fetch(API_URL, { 
                        method: 'POST', 
                        body: JSON.stringify({ action: 'redeem_coupon', password: PASSWORD, phone: phone, couponData: couponData }) 
                    })
                    .then(r => r.json()).then(res => {
                        hideLoading();
                        Swal.fire('å·²æ ¸éŠ·', res.message, 'success');
                        searchMember();
                    });
                }
            });
        }

        // æ•¸æ“šå ±è¡¨
        function loadStats() {
            var list = document.getElementById('statsList');
            list.innerHTML = "<div style='text-align:center; color:#777;'>è¼‰å…¥ä¸­...</div>";

            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'get_stats', password: PASSWORD }) })
            .then(r => r.json()).then(res => {
                if(res.status !== 'success') return list.innerHTML = "è¼‰å…¥å¤±æ•—";
                list.innerHTML = "";
                var stats = res.data;
                var keys = Object.keys(stats);
                
                if(keys.length === 0) {
                    list.innerHTML = "<div style='text-align:center;'>ç›®å‰ç„¡æ•¸æ“š</div>";
                    return;
                }

                keys.forEach(key => {
                    var item = stats[key];
                    var rate = item.sent > 0 ? Math.round((item.redeemed / item.sent) * 100) : 0;
                    list.innerHTML += `
                        <div class="stat-item" style="background:#444; padding:15px; border-radius:8px; margin-bottom:10px; border-left:4px solid #E2C8BA;">
                            <span style="font-weight:700;">${key}</span>
                            <div style="display:flex; justify-content:space-between; font-size:14px; margin-top:8px;">
                                <span>ç™¼é€: ${item.sent}</span>
                                <span>æ ¸éŠ·: ${item.redeemed}</span>
                                <span style="color:#E2C8BA;">ä½¿ç”¨ç‡: ${rate}%</span>
                            </div>
                        </div>`;
                });
            });
        }
    </script>
</body>
</html>